<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FreeMap - Self-Hosted Maps</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 0;
    }

    .sidebar {
      width: 350px;
      background: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .sidebar h1 {
      font-size: 24px;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar p {
      font-size: 12px;
      color: #999;
      margin-bottom: 20px;
    }

    .search-group {
      margin-bottom: 15px;
    }

    .search-group label {
      display: block;
      font-size: 12px;
      color: #666;
      font-weight: 600;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .search-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .search-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-results {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 5px;
      display: none;
    }

    .search-results.show {
      display: block;
    }

    .search-result-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 12px;
      color: #333;
      transition: background 0.2s;
    }

    .search-result-item:hover {
      background: #f5f5f5;
    }

    .button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .route-info {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .route-info.show {
      display: block;
    }

    .route-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .route-info-item label {
      font-weight: 600;
      color: #666;
    }

    .route-info-item value {
      color: #667eea;
      font-weight: 600;
    }

    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: 35%;
      }

      .map-container {
        height: 65%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h1>üó∫Ô∏è FreeMap</h1>
      <p>Self-hosted maps. Zero subscriptions.</p>

      <div class="search-group">
        <label>From</label>
        <input type="text" id="startInput" placeholder="Search location...">
        <div class="search-results" id="startResults"></div>
      </div>

      <div class="search-group">
        <label>To</label>
        <input type="text" id="endInput" placeholder="Search destination...">
        <div class="search-results" id="endResults"></div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="getRoute()">Get Route</button>
        <button class="btn-secondary" onclick="clearRoute()">Clear</button>
      </div>

      <div class="route-info" id="routeInfo">
        <div class="route-info-item">
          <label>Distance:</label>
          <value id="distance">-</value>
        </div>
        <div class="route-info-item">
          <label>Time:</label>
          <value id="duration">-</value>
        </div>
      </div>

      <div style="flex: 1;"></div>
      <p style="font-size: 11px; color: #999; text-align: center; margin-top: 20px;">
        Powered by OpenStreetMap & OSRM
      </p>
    </div>

    <div class="map-container">
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([51.505, -0.09], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);

    let startMarker = null;
    let endMarker = null;
    let routeLayer = null;
    let startLocation = null;
    let endLocation = null;

    // Geocode search
    async function geocodeSearch(query, resultElementId) {
      if (query.length < 2) return;

      try {
        const response = await fetch(`/api/geocode?q=${encodeURIComponent(query)}`);
        const results = await response.json();

        const resultsDiv = document.getElementById(resultElementId);
        resultsDiv.innerHTML = '';

        if (results.length > 0) {
          resultsDiv.classList.add('show');
          results.slice(0, 5).forEach(result => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.textContent = result.display_name.split(',')[0];
            item.onclick = () => selectLocation(result, resultElementId);
            resultsDiv.appendChild(item);
          });
        } else {
          resultsDiv.classList.remove('show');
        }
      } catch (error) {
        console.error('Geocode error:', error);
      }
    }

    function selectLocation(result, type) {
      const lat = parseFloat(result.lat);
      const lng = parseFloat(result.lon);
      const name = result.display_name.split(',')[0];

      if (type === 'startResults') {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([lat, lng], { title: name }).addTo(map);
        startMarker.bindPopup(`<b>From:</b> ${name}`).openPopup();
        document.getElementById('startInput').value = name;
        startLocation = { lat, lng };
        document.getElementById('startResults').classList.remove('show');
        map.flyTo([lat, lng], 13);
      } else {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng], { title: name }).addTo(map);
        endMarker.bindPopup(`<b>To:</b> ${name}`).openPopup();
        document.getElementById('endInput').value = name;
        endLocation = { lat, lng };
        document.getElementById('endResults').classList.remove('show');
        map.flyTo([lat, lng], 13);
      }
    }

    async function getRoute() {
      if (!startLocation || !endLocation) {
        alert('Please select both start and end locations');
        return;
      }

      try {
        const response = await fetch(
          `/api/route?start_lat=${startLocation.lat}&start_lng=${startLocation.lng}&end_lat=${endLocation.lat}&end_lng=${endLocation.lng}`
        );
        const route = await response.json();

        if (route.error) {
          alert('Route not found');
          return;
        }

        if (routeLayer) map.removeLayer(routeLayer);

        routeLayer = L.geoJSON(route.geometry, {
          style: {
            color: '#667eea',
            weight: 4,
            opacity: 0.7
          }
        }).addTo(map);

        document.getElementById('distance').textContent = route.distance.toFixed(1) + ' km';
        document.getElementById('duration').textContent = Math.round(route.duration) + ' min';
        document.getElementById('routeInfo').classList.add('show');

        map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
      } catch (error) {
        console.error('Route error:', error);
        alert('Error calculating route');
      }
    }

    function clearRoute() {
      if (startMarker) map.removeLayer(startMarker);
      if (endMarker) map.removeLayer(endMarker);
      if (routeLayer) map.removeLayer(routeLayer);
      startMarker = null;
      endMarker = null;
      routeLayer = null;
      startLocation = null;
      endLocation = null;
      document.getElementById('startInput').value = '';
      document.getElementById('endInput').value = '';
      document.getElementById('routeInfo').classList.remove('show');
    }

    document.getElementById('startInput').addEventListener('input', (e) => {
      geocodeSearch(e.target.value, 'startResults');
    });

    document.getElementById('endInput').addEventListener('input', (e) => {
      geocodeSearch(e.target.value, 'endResults');
    });

    // Click on map to set locations
    map.on('click', function(e) {
      if (document.activeElement === document.getElementById('startInput')) {
        startLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
        document.getElementById('startInput').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
      } else if (document.activeElement === document.getElementById('endInput')) {
        endLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
        document.getElementById('endInput').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
      }
    });
  </script>
</body>
</html>
